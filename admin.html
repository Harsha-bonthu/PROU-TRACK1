<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard — Mock Store</title>
  <link rel="stylesheet" href="style.css">
  <style>
    canvas{background:transparent;border-radius:8px;max-width:100%}
    /* keep admin charts a sensible height on large screens */
    #favChart, #priceChart { height: 320px; max-height: 420px; }
    #salesChart { height: 260px; max-height: 360px; }
    @media (max-width:900px){ #favChart, #priceChart { height: 280px } #salesChart{ height:220px } }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="brand"><h1>Admin — Mock Store</h1></div>
      <div class="header-actions"><a class="chip" href="index.html">Back</a></div>
    </div>
  </header>

  <main class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px">
      <h2>Analytics</h2>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="export-orders" class="btn">Export Orders CSV</button>
        <button id="seed-data" class="btn" style="background:#10b981">Seed Demo Data</button>
        <a class="chip" href="#" id="signout">Sign out</a>
      </div>
    </div>
    <section style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:6px">
      <div>
        <h3>Favorites per product</h3>
        <canvas id="favChart" width="600" height="320"></canvas>
      </div>
      <div>
        <h3>Price distribution</h3>
        <canvas id="priceChart" width="600" height="320"></canvas>
      </div>
    </section>

    <section style="margin-top:20px">
      <h3>Mock sales (last 7 days)</h3>
      <canvas id="salesChart" width="1000" height="240"></canvas>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="auth.js"></script>
  <script>
    // Protect page: require logged-in user
    const user = window.__mockAuth && window.__mockAuth.getUser && window.__mockAuth.getUser();
    if(!user){
      // redirect to login and come back
      location.href = 'login.html?redirect=admin.html';
    }

    async function loadData(){
      const res = await fetch('data.json');
      return res.ok ? res.json() : [];
    }

    function getFavCounts(data){
      // aggregate favorites across global and user-scoped keys
      const map = new Map(); data.forEach(d=>map.set(d.id,0));
      try{
        Object.keys(localStorage).forEach(k=>{
          if(k === 'favs' || k.endsWith(':favs')){
            const raw = JSON.parse(localStorage.getItem(k)||'[]');
            (raw||[]).forEach(id=>{ const n = Number(id); if(map.has(n)) map.set(n, map.get(n)+1) });
          }
        });
      }catch(e){}
      return data.map(d=>map.get(d.id)||0);
    }

    (async ()=>{
      const data = await loadData();
      const labels = data.map(d=>d.title);
      // favorites
      const favs = JSON.parse(localStorage.getItem('favs')||'[]').map(x=>Number(x));
      const favCounts = data.map(d => favs.filter(id=>id===d.id).length);

      const favCtx = document.getElementById('favChart').getContext('2d');
      new Chart(favCtx, { type: 'bar', data: { labels, datasets: [{ label:'Favorites', data: favCounts, backgroundColor:'#60a5fa' }] }, options: {responsive:true, maintainAspectRatio:false} });

      // price chart
      const prices = data.map(d=>d.price);
      const priceCtx = document.getElementById('priceChart').getContext('2d');
      new Chart(priceCtx, { type:'bar', data:{ labels, datasets:[{ label:'Price (USD)', data: prices, backgroundColor:'#34d399' }] }, options:{responsive:true, maintainAspectRatio:false} });

      // sales from recorded orders (last 7 days) — aggregate global + user-scoped orders
      const orders = (function(){
        const out = [];
        try{
          Object.keys(localStorage).forEach(k=>{
            if(k === 'orders' || k.endsWith(':orders')){
              try{ const arr = JSON.parse(localStorage.getItem(k)||'[]'); if(Array.isArray(arr)) out.push(...arr); }catch(e){}
            }
          });
        }catch(e){}
        return out;
      })();
      const msPerDay = 24 * 60 * 60 * 1000;
      const today = new Date();
      const days = Array.from({length:7}).map((_,i)=>{
        const dt = new Date(); dt.setDate(dt.getDate()- (6-i)); return dt.toLocaleDateString();
      });
      const totals = days.map((label, idx) => {
        const dayStart = new Date(); dayStart.setHours(0,0,0,0); dayStart.setDate(dayStart.getDate() - (6 - idx));
        const dayEnd = new Date(dayStart.getTime() + msPerDay);
        return orders.filter(o => { const t = new Date(o.ts); return t >= dayStart && t < dayEnd }).reduce((s,o)=> s + (o.total||0), 0);
      });
      const salesCtx = document.getElementById('salesChart').getContext('2d');
      new Chart(salesCtx, { type:'line', data:{ labels: days, datasets:[{ label:'Sales (USD)', data: totals, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.12)', fill:true }] }, options:{responsive:true, maintainAspectRatio:false, scales:{ y: { beginAtZero:true } } } });

      // export CSV
      document.getElementById('export-orders').addEventListener('click', ()=>{
        const orders = (function(){
          const out = [];
          try{ Object.keys(localStorage).forEach(k=>{ if(k === 'orders' || k.endsWith(':orders')){ try{ const arr = JSON.parse(localStorage.getItem(k)||'[]'); if(Array.isArray(arr)) out.push(...arr); }catch(e){} } }); }catch(e){}
          return out;
        })();
        if(!orders.length) { alert('No orders to export'); return; }
        const rows = [];
        rows.push(['order_id','ts','user_email','item_id','item_title','qty','price','subtotal','order_total']);
        orders.forEach(o=>{
          const userEmail = o.user && o.user.email ? o.user.email : '';
          (o.items||[]).forEach(it=>{
            rows.push([o.id, new Date(o.ts).toISOString(), userEmail, it.id, it.title, it.qty, it.price, it.subtotal, o.total]);
          })
        });
        const csv = rows.map(r => r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'orders.csv'; a.click(); URL.revokeObjectURL(url);
      });

      // seed demo data (adds some favs and an order to localStorage)
      document.getElementById('seed-data').addEventListener('click', ()=>{
        // seed favorites and an order globally and under a demo user
        try{
          // global favs
          localStorage.setItem('favs', JSON.stringify([1,3,3,2]));
          // demo user pref
          localStorage.setItem('user:demo@local:favs', JSON.stringify([2,2,3]));
          // create demo orders
          const demoOrder = { id: 'ord_demo_' + Date.now(), ts: Date.now(), total: 150, user: { email: 'demo@local' }, items: [{id:1,title:'Aurora Running Shoes',qty:1,price:89.99,subtotal:89.99}, {id:3,title:'Nimbus Wireless Earbuds',qty:1,price:60.01,subtotal:60.01}] };
          const globalOrders = JSON.parse(localStorage.getItem('orders')||'[]'); globalOrders.push(demoOrder); localStorage.setItem('orders', JSON.stringify(globalOrders));
          const userOrders = JSON.parse(localStorage.getItem('user:demo@local:orders')||'[]'); userOrders.push(demoOrder); localStorage.setItem('user:demo@local:orders', JSON.stringify(userOrders));
          alert('Demo data seeded. Reloading dashboard...');
          location.reload();
        }catch(e){ console.error(e); alert('Failed to seed demo data'); }
      });

      // sign out
      document.getElementById('signout').addEventListener('click', (e)=>{ e.preventDefault(); if(confirm('Sign out?')){ window.__mockAuth && window.__mockAuth.logout && window.__mockAuth.logout(); location.href='index.html'; } });
    })();
  </script>
</body>
</html>
